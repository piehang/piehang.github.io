<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Login</title>
</head>
<body>
<h2>请输入密码</h2>
<input type="password" id="p">
<button id="b">进入</button>
<p id="e" style="color:red;"></p>
<script>
const K = "a94b4c2f184927cc";

// 固定 IV，保证加密数据可解密
const IV = new Uint8Array(16); // 全 0

// 硬编码的加密密码和目标页面（用固定 IV 加密后的 base64）
const EP = "2zj5UrMzpBfPUVx6LxKnGgD88K9v8u1+3n3syxC5RO8=";
const ED = "2zj5UrMzpBfPUVx6LxKnGg=="; // downloads.html 加密后的示例

async function aesKey(key) {
  return crypto.subtle.importKey(
    "raw", 
    new TextEncoder().encode(key),
    "AES-CBC", 
    false, 
    ["encrypt", "decrypt"]
  );
}

async function encryptAES(text, key) {
  const keyObj = await aesKey(key);
  const encoder = new TextEncoder();
  const data = encoder.encode(text);
  const paddingLen = 16 - (data.length % 16);
  const paddedData = new Uint8Array(data.length + paddingLen);
  paddedData.set(data);
  paddedData.fill(paddingLen, data.length);
  const encrypted = await crypto.subtle.encrypt(
    { name: "AES-CBC", iv: IV },
    keyObj,
    paddedData
  );
  return btoa(String.fromCharCode(...new Uint8Array(encrypted)));
}

async function decryptAES(base64, key) {
  const raw = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
  const keyObj = await aesKey(key);
  const decrypted = await crypto.subtle.decrypt(
    { name: "AES-CBC", iv: IV },
    keyObj,
    raw
  );
  const decryptedArr = new Uint8Array(decrypted);
  const paddingLen = decryptedArr[decryptedArr.length - 1];
  const unpadded = decryptedArr.slice(0, decryptedArr.length - paddingLen);
  return new TextDecoder().decode(unpadded);
}

document.getElementById("b").onclick = async () => {
  const input = document.getElementById("p").value;
  const errorEl = document.getElementById("e");
  try {
    const pwd = await decryptAES(EP, K);
    if (input !== pwd) {
      errorEl.textContent = "密码错误";
      return;
    }
    const target = await decryptAES(ED, K);
    errorEl.textContent = "";
    window.location.href = target;
  } catch (err) {
    errorEl.textContent = "解密失败：" + err.message;
    console.error(err);
  }
};
</script>
</body>
</html>